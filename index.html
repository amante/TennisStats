<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tennis Win Probabilities — v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Probabilidades de ganar un partido de tenis entre dos jugadores usando modelo logístico + simulación Monte Carlo por sets, con odds e intervalos de confianza." />
  <style>
    .card { transition: box-shadow .2s ease, transform .2s ease; }
    .card:hover { box-shadow: 0 10px 24px rgba(0,0,0,.08); transform: translateY(-1px); }
    .mono { font-feature-settings: "ss01" on, "ss02" on; }
    .number-input::-webkit-outer-spin-button, .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .number-input { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Tennis Match Win Probabilities</h1>
      <div class="text-sm text-slate-500">v2.0 • 2025‑10‑06</div>
    </div>
    <p class="mt-2 text-slate-600">
      Modelo <span class="font-semibold">logístico</span> + <span class="font-semibold">simulación Monte Carlo por sets</span>, con conversión a <span class="italic">odds</span>
      (decimal/americana) e <span class="italic">intervalos de confianza</span>.
    </p>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-28">
    <!-- Configuración global -->
    <section class="card bg-white rounded-2xl shadow-sm p-5 md:p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Superficie</label>
          <select id="surface" class="w-full rounded-xl border border-slate-200 p-2.5">
            <option value="hard">Hard</option>
            <option value="clay">Clay</option>
            <option value="grass">Grass</option>
            <option value="carpet">Carpet/Indoor</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Formato del partido</label>
          <select id="format" class="w-full rounded-xl border border-slate-200 p-2.5">
            <option value="bo3">Best of 3</option>
            <option value="bo5">Best of 5</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">H2H: Gana A</label>
            <input id="h2hA" type="number" min="0" step="1" value="0" class="number-input w-full rounded-xl border border-slate-200 p-2.5"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">H2H: Gana B</label>
            <input id="h2hB" type="number" min="0" step="1" value="0" class="number-input w-full rounded-xl border border-slate-200 p-2.5"/>
          </div>
        </div>
      </div>
    </section>

    <!-- Jugadores -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Jugador A -->
      <div class="card bg-white rounded-2xl shadow-sm p-5 md:p-6">
        <h2 class="text-lg font-semibold mb-4">Jugador A</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Nombre</label>
            <input id="nameA" type="text" placeholder="Jugador A" class="w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Ranking (ATP/WTA)</label>
            <input id="rankA" type="number" min="1" step="1" placeholder="opcional" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Elo (opcional)</label>
            <input id="eloA" type="number" min="500" max="3500" step="1" placeholder="opcional" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Forma (últ. 10): Victorias</label>
            <input id="formWinsA" type="number" min="0" max="10" step="1" value="5" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Superficie (últ. 10): Victorias</label>
            <input id="surfWinsA" type="number" min="0" max="10" step="1" value="5" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Juegos de saque ganados %</label>
            <input id="holdA" type="number" min="0" max="100" step="0.1" value="80" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Juegos de resto ganados %</label>
            <input id="breakA" type="number" min="0" max="100" step="0.1" value="25" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
        </div>
      </div>

      <!-- Jugador B -->
      <div class="card bg-white rounded-2xl shadow-sm p-5 md:p-6">
        <h2 class="text-lg font-semibold mb-4">Jugador B</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Nombre</label>
            <input id="nameB" type="text" placeholder="Jugador B" class="w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Ranking (ATP/WTA)</label>
            <input id="rankB" type="number" min="1" step="1" placeholder="opcional" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Elo (opcional)</label>
            <input id="eloB" type="number" min="500" max="3500" step="1" placeholder="opcional" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Forma (últ. 10): Victorias</label>
            <input id="formWinsB" type="number" min="0" max="10" step="1" value="5" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Superficie (últ. 10): Victorias</label>
            <input id="surfWinsB" type="number" min="0" max="10" step="1" value="5" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Juegos de saque ganados %</label>
            <input id="holdB" type="number" min="0" max="100" step="0.1" value="80" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Juegos de resto ganados %</label>
            <input id="breakB" type="number" min="0" max="100" step="0.1" value="25" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
          </div>
        </div>
      </div>
    </section>

    <!-- Ajustes del modelo y simulación -->
    <details class="card bg-white rounded-2xl shadow-sm p-5 md:p-6 mb-6 open:animate-[fadeIn_.2s_ease]">
      <summary class="cursor-pointer text-lg font-semibold mb-2">Ajustes (modelo & simulación)</summary>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mt-3">
        <div>
          <label class="block text-sm font-medium mb-1">Peso Elo/Ranking</label>
          <input id="wElo" type="number" step="0.05" value="1.00" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Peso Superficie</label>
          <input id="wSurf" type="number" step="0.05" value="0.80" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Peso Forma</label>
          <input id="wForm" type="number" step="0.05" value="0.60" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Peso H2H</label>
          <input id="wH2H" type="number" step="0.05" value="0.40" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Peso Saque+Resto</label>
          <input id="wSR" type="number" step="0.05" value="0.80" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Escala logística (k)</label>
          <input id="kScale" type="number" step="0.05" value="1.00" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Simulaciones Monte Carlo</label>
          <input id="mcRuns" type="number" min="100" step="100" value="5000" class="number-input w-full rounded-xl border border-slate-200 p-2.5" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Saca primero</label>
          <select id="firstServe" class="w-full rounded-xl border border-slate-200 p-2.5">
            <option value="random">Aleatorio</option>
            <option value="A">Jugador A</option>
            <option value="B">Jugador B</option>
          </select>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-3">
        La simulación por sets usa <span class="font-medium">hold%</span> y <span class="font-medium">break%</span> para derivar la probabilidad de ganar cada juego en función del servidor.
        El tie‑break se aproxima con una probabilidad basada en el desempeño medio de juego.
      </p>
    </details>

    <!-- Acciones -->
    <section class="flex flex-wrap items-center gap-3 mb-6">
      <button id="calcBtn" class="px-4 py-2.5 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-500 active:bg-indigo-700">Calcular probabilidad</button>
      <button id="resetBtn" class="px-4 py-2.5 rounded-xl bg-slate-200 text-slate-800 font-medium hover:bg-slate-300">Reset</button>
      <div class="ml-auto flex items-center gap-2">
        <button id="exportBtn" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-500">Exportar JSON</button>
        <label class="px-3 py-2 rounded-xl bg-slate-800 text-white text-sm font-medium cursor-pointer hover:bg-slate-700">
          Importar JSON
          <input id="importFile" type="file" accept="application/json" class="hidden" />
        </label>
      </div>
    </section>

    <!-- Resultados -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card bg-white rounded-2xl shadow-sm p-5 md:p-6 lg:col-span-2">
        <h3 class="text-lg font-semibold mb-1">Resultado del partido</h3>
        <p class="text-xs text-slate-500 mb-4">Se muestran las probabilidades del <span class="font-medium">modelo logístico</span> y la <span class="font-medium">simulación Monte Carlo</span>.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-start">
          <div>
            <div class="flex items-center justify-between mb-1">
              <div class="text-sm text-slate-600"><span id="labelA" class="font-medium">Jugador A</span> gana</div>
              <div class="text-sm font-semibold" id="pA">–</div>
            </div>
            <div class="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
              <div id="barA" class="h-3 bg-indigo-600" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-xs text-slate-600">
              Logístico: <span id="pA_logit">–</span> • Monte Carlo: <span id="pA_mc">–</span> <span id="pA_ci" class="text-slate-500"></span>
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <div class="text-sm text-slate-600"><span id="labelB" class="font-medium">Jugador B</span> gana</div>
              <div class="text-sm font-semibold" id="pB">–</div>
            </div>
            <div class="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
              <div id="barB" class="h-3 bg-slate-900" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-xs text-slate-600">
              Logístico: <span id="pB_logit">–</span> • Monte Carlo: <span id="pB_mc">–</span> <span id="pB_ci" class="text-slate-500"></span>
            </div>
          </div>
        </div>
        <div class="mt-4 text-sm text-slate-600">Confianza del modelo (inputs): <span id="confidence" class="font-medium">–</span></div>
      </div>

      <div class="card bg-white rounded-2xl shadow-sm p-5 md:p-6">
        <h3 class="text-lg font-semibold mb-3">Odds equivalentes</h3>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-100">
            <div class="font-semibold mb-1" id="oddsALabel">Jugador A</div>
            <div>Decimal: <span id="oddsA_dec">–</span></div>
            <div>Americana: <span id="oddsA_amer">–</span></div>
          </div>
          <div class="p-3 rounded-xl bg-slate-100">
            <div class="font-semibold mb-1" id="oddsBLabel">Jugador B</div>
            <div>Decimal: <span id="oddsB_dec">–</span></div>
            <div>Americana: <span id="oddsB_amer">–</span></div>
          </div>
        </div>
        <h4 class="text-sm font-semibold mt-4 mb-2">Desglose de contribuciones (modelo logístico)</h4>
        <ul id="contrib" class="space-y-2 text-sm"></ul>
        <p class="mt-3 text-xs text-slate-500">Las contribuciones son previas a la logística. Positivo favorece a <span class="font-medium">Jugador A</span>, negativo a <span class="font-medium">Jugador B</span>.</p>
      </div>
    </section>

    <footer class="mt-10 text-center text-xs text-slate-500">v2.0 • Simulación por sets + odds • Ajusta, itera y valida con tus datos</footer>
  </main>

  <script type="module">
    const $ = (id) => document.getElementById(id);

    // Utilidades
    const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
    const logistic = (x) => 1 / (1 + Math.exp(-x));
    const fmtPct = (p) => (Math.round(p * 1000) / 10) + '%';

    function parseNum(el, fallback = null) {
      const v = parseFloat(el.value);
      return Number.isFinite(v) ? v : fallback;
    }

    function pseudoEloFromRank(rank) {
      if (!Number.isFinite(rank)) return null;
      const e = 2600 - 2.0 * Math.min(rank, 800);
      return clamp(e, 1200, 2600);
    }

    function getPlayerInput(prefix) {
      return {
        name: $("name"+prefix).value.trim() || (prefix === 'A' ? 'Jugador A' : 'Jugador B'),
        rank: parseNum($("rank"+prefix)),
        elo: parseNum($("elo"+prefix)),
        formWins: clamp(parseNum($("formWins"+prefix), 5), 0, 10),
        surfWins: clamp(parseNum($("surfWins"+prefix), 5), 0, 10),
        hold: clamp(parseNum($("hold"+prefix), 80), 0, 100),
        brk: clamp(parseNum($("break"+prefix), 25), 0, 100),
      };
    }

    function computeWeights() {
      return {
        wElo: parseNum($("wElo"), 1.0),
        wSurf: parseNum($("wSurf"), 0.8),
        wForm: parseNum($("wForm"), 0.6),
        wH2H: parseNum($("wH2H"), 0.4),
        wSR: parseNum($("wSR"), 0.8),
        k: parseNum($("kScale"), 1.0),
      };
    }

    function computeFeatures(A, B, h2hA, h2hB) {
      const eloA = Number.isFinite(A.elo) ? A.elo : pseudoEloFromRank(A.rank);
      const eloB = Number.isFinite(B.elo) ? B.elo : pseudoEloFromRank(B.rank);
      const eloDiff = (Number.isFinite(eloA) && Number.isFinite(eloB)) ? (eloA - eloB) : 0;
      const fElo = eloDiff / 100;

      const fForm = (A.formWins - B.formWins) / 10;
      const fSurf = (A.surfWins - B.surfWins) / 10;

      const totalH2H = h2hA + h2hB;
      const frac = totalH2H > 0 ? (h2hA - h2hB) / (totalH2H + 1) : 0;
      const fH2H = frac;

      const srA = (A.hold + A.brk) - 100;
      const srB = (B.hold + B.brk) - 100;
      const fSR = (srA - srB) / 20;

      return { fElo, fSurf, fForm, fH2H, fSR, eloA, eloB };
    }

    function combineToProbability(features, weights, bo5 = false) {
      const { fElo, fSurf, fForm, fH2H, fSR } = features;
      const { wElo, wSurf, wForm, wH2H, wSR, k } = weights;
      const score = (wElo*fElo) + (wSurf*fSurf) + (wForm*fForm) + (wH2H*fH2H) + (wSR*fSR);
      let p = logistic(k * score);
      if (bo5) {
        const f = 1.35;
        const odds = p / (1 - p);
        const adjOdds = Math.pow(odds, f);
        p = adjOdds / (1 + adjOdds);
      }
      return { pA: p, score };
    }

    // -------- Simulación por sets (Monte Carlo) ----------

    function pickFirstServer(mode) {
      if (mode === 'A' || mode === 'B') return mode;
      return Math.random() < 0.5 ? 'A' : 'B';
    }

    function tieBreakProb(pHoldA, pHoldB) {
      // Aproximación: usa probabilidad media de juego como proxy (sin servidor)
      const pGameA = (pHoldA + (1 - pHoldB)) / 2;
      return logistic(5 * (pGameA - 0.5)); // c=5 -> más sensible a ventajas
    }

    function simulateSet(pHoldA, pHoldB, firstServer) {
      let a = 0, b = 0;
      let server = firstServer; // 'A' o 'B'
      for (let g = 0; g < 50; g++) { // 50 es un límite de seguridad
        const pA = server === 'A' ? pHoldA : (1 - pHoldB);
        if (Math.random() < pA) a++; else b++;
        // victoria normal (6+ con diferencia de 2)
        if ((a >= 6 || b >= 6) && Math.abs(a - b) >= 2) {
          return a > b ? 'A' : 'B';
        }
        // tie-break a 6-6
        if (a === 6 && b === 6) {
          const pTB = tieBreakProb(pHoldA, pHoldB);
          return (Math.random() < pTB) ? 'A' : 'B';
        }
        server = server === 'A' ? 'B' : 'A';
      }
      // fallback improbable
      return a >= b ? 'A' : 'B';
    }

    function simulateMatch(format, pHoldA, pHoldB, firstServeMode) {
      const need = (format === 'bo5') ? 3 : 2;
      let setsA = 0, setsB = 0;
      while (setsA < need && setsB < need) {
        const fs = pickFirstServer(firstServeMode);
        const w = simulateSet(pHoldA, pHoldB, fs);
        if (w === 'A') setsA++; else setsB++;
      }
      return setsA > setsB ? 'A' : 'B';
    }

    function runMonteCarlo(format, pHoldA, pHoldB, firstServeMode, runs = 5000) {
      let winsA = 0;
      for (let i = 0; i < runs; i++) {
        if (simulateMatch(format, pHoldA, pHoldB, firstServeMode) === 'A') winsA++;
      }
      const p = winsA / runs;
      // 95% CI normal aprox
      const se = Math.sqrt(p * (1 - p) / runs);
      const lo = clamp(p - 1.96 * se, 0, 1);
      const hi = clamp(p + 1.96 * se, 0, 1);
      return { pA: p, ci: [lo, hi], runs };
    }

    // Odds
    function toDecimalOdds(p) {
      if (p <= 0) return '∞';
      return (1 / p).toFixed(2);
    }
    function toAmericanOdds(p) {
      if (p <= 0 || p >= 1) return '—';
      if (p > 0.5) {
        const val = Math.round(100 * p / (1 - p));
        return '-' + val;
      } else {
        const val = Math.round(100 * (1 - p) / p);
        return '+' + val;
      }
    }

    // Render UI
    function render(A, B, pLogit, feats, weights, mcRes) {
      $("labelA").textContent = A.name || 'Jugador A';
      $("labelB").textContent = B.name || 'Jugador B';
      const pA_final = mcRes ? mcRes.pA : pLogit;
      const pB_final = 1 - pA_final;

      $("pA").textContent = fmtPct(pA_final);
      $("pB").textContent = fmtPct(pB_final);
      $("barA").style.width = (pA_final * 100) + '%';
      $("barB").style.width = (pB_final * 100) + '%';

      // Subdetalles
      $("pA_logit").textContent = fmtPct(pLogit);
      $("pB_logit").textContent = fmtPct(1 - pLogit);
      if (mcRes) {
        $("pA_mc").textContent = fmtPct(mcRes.pA);
        $("pB_mc").textContent = fmtPct(1 - mcRes.pA);
        $("pA_ci").textContent = ` (IC95% ${fmtPct(mcRes.ci[0])}–${fmtPct(mcRes.ci[1])}, n=${mcRes.runs})`;
        $("pB_ci").textContent = ` (IC95% ${fmtPct(1 - mcRes.ci[1])}–${fmtPct(1 - mcRes.ci[0])}, n=${mcRes.runs})`;
      } else {
        $("pA_mc").textContent = '—';
        $("pB_mc").textContent = '—';
        $("pA_ci").textContent = '';
        $("pB_ci").textContent = '';
      }

      // Odds desde la probabilidad final (por defecto tomamos Monte Carlo si existe)
      $("oddsALabel").textContent = A.name || 'Jugador A';
      $("oddsBLabel").textContent = B.name || 'Jugador B';
      $("oddsA_dec").textContent = toDecimalOdds(pA_final);
      $("oddsB_dec").textContent = toDecimalOdds(pB_final);
      $("oddsA_amer").textContent = toAmericanOdds(pA_final);
      $("oddsB_amer").textContent = toAmericanOdds(pB_final);

      // Contribuciones (del modelo logístico)
      const list = $("contrib");
      list.innerHTML = '';
      const items = [
        {label: 'Elo/Ranking', val: weights.wElo * feats.fElo},
        {label: 'Superficie',  val: weights.wSurf * feats.fSurf},
        {label: 'Forma',       val: weights.wForm * feats.fForm},
        {label: 'Head‑to‑Head',val: weights.wH2H * feats.fH2H},
        {label: 'Saque+Resto', val: weights.wSR * feats.fSR},
      ];
      for (const it of items) {
        const sign = it.val >= 0 ? '+' : '−';
        const mag = Math.abs(it.val);
        const pct = clamp(Math.round((mag / 3) * 100), 0, 100);
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="flex items-center justify-between">
            <div>${it.label}</div>
            <div class="mono tabular-nums">${sign}${mag.toFixed(2)}</div>
          </div>
          <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden mt-1">
            <div class="h-2 ${it.val>=0 ? 'bg-indigo-600' : 'bg-slate-900'}" style="width:${pct}%"></div>
          </div>
        `;
        list.appendChild(li);
      }
    }

    function computeConfidence(A, B) {
      let parts = 0;
      if (Number.isFinite(A.elo) || Number.isFinite(A.rank)) parts++;
      if (Number.isFinite(B.elo) || Number.isFinite(B.rank)) parts++;
      if (A.formWins !== null && B.formWins !== null) parts++;
      if (A.surfWins !== null && B.surfWins !== null) parts++;
      if (A.hold !== null && A.brk !== null && B.hold !== null && B.brk !== null) parts++;
      const conf = clamp((parts / 5) * 100, 0, 100);
      const eloDerivedPenalty = (!Number.isFinite(A.elo) || !Number.isFinite(B.elo)) ? 8 : 0;
      return clamp(Math.round(conf - eloDerivedPenalty), 0, 100);
    }

    function readAllInputs() {
      const A = getPlayerInput('A');
      const B = getPlayerInput('B');
      const h2hA = clamp(parseNum($("h2hA"), 0), 0, 999);
      const h2hB = clamp(parseNum($("h2hB"), 0), 0, 999);
      const weights = computeWeights();
      const format = $("format").value;
      const mcRuns = clamp(parseNum($("mcRuns"), 5000), 100, 1000000);
      const firstServe = $("firstServe").value;
      return { A, B, h2hA, h2hB, weights, format, mcRuns, firstServe };
    }

    function validateInputs(A, B) {
      const errs = [];
      for (const [lbl, v] of [["A hold%", A.hold],["A break%", A.brk],["B hold%", B.hold],["B break%", B.brk]]) {
        if (!Number.isFinite(v) || v < 0 || v > 100) errs.push(`${lbl} debe estar en 0–100`);
      }
      for (const [lbl, v] of [["A forma", A.formWins],["B forma", B.formWins],["A superficie", A.surfWins],["B superficie", B.surfWins]]) {
        if (!Number.isFinite(v) || v < 0 || v > 10) errs.push(`${lbl} (victorias) debe estar en 0–10`);
      }
      return errs;
    }

    function exportJSON() {
      const state = {
        surface: $("surface").value,
        format: $("format").value,
        h2hA: parseNum($("h2hA"), 0),
        h2hB: parseNum($("h2hB"), 0),
        playerA: {
          name: $("nameA").value,
          rank: parseNum($("rankA")), elo: parseNum($("eloA")),
          formWins: parseNum($("formWinsA"), 5),
          surfWins: parseNum($("surfWinsA"), 5),
          hold: parseNum($("holdA"), 80), brk: parseNum($("breakA"), 25)
        },
        playerB: {
          name: $("nameB").value,
          rank: parseNum($("rankB")), elo: parseNum($("eloB")),
          formWins: parseNum($("formWinsB"), 5),
          surfWins: parseNum($("surfWinsB"), 5),
          hold: parseNum($("holdB"), 80), brk: parseNum($("breakB"), 25)
        },
        weights: computeWeights(),
        mc: { runs: parseNum($("mcRuns"), 5000), firstServe: $("firstServe").value },
        version: 'v2.0',
        savedAt: new Date().toISOString(),
      };
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `tennis_model_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJSON(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.surface) $("surface").value = data.surface;
          if (data.format) $("format").value = data.format;
          if (Number.isFinite(data.h2hA)) $("h2hA").value = data.h2hA;
          if (Number.isFinite(data.h2hB)) $("h2hB").value = data.h2hB;
          const A = data.playerA || {}; const B = data.playerB || {};
          $("nameA").value = A.name || '';
          $("rankA").value = Number.isFinite(A.rank) ? A.rank : '';
          $("eloA").value = Number.isFinite(A.elo) ? A.elo : '';
          $("formWinsA").value = Number.isFinite(A.formWins) ? A.formWins : 5;
          $("surfWinsA").value = Number.isFinite(A.surfWins) ? A.surfWins : 5;
          $("holdA").value = Number.isFinite(A.hold) ? A.hold : 80;
          $("breakA").value = Number.isFinite(A.brk) ? A.brk : 25;
          $("nameB").value = B.name || '';
          $("rankB").value = Number.isFinite(B.rank) ? B.rank : '';
          $("eloB").value = Number.isFinite(B.elo) ? B.elo : '';
          $("formWinsB").value = Number.isFinite(B.formWins) ? B.formWins : 5;
          $("surfWinsB").value = Number.isFinite(B.surfWins) ? B.surfWins : 5;
          $("holdB").value = Number.isFinite(B.hold) ? B.hold : 80;
          $("breakB").value = Number.isFinite(B.brk) ? B.brk : 25;
          const W = data.weights || {};
          if (Number.isFinite(W.wElo)) $("wElo").value = W.wElo;
          if (Number.isFinite(W.wSurf)) $("wSurf").value = W.wSurf;
          if (Number.isFinite(W.wForm)) $("wForm").value = W.wForm;
          if (Number.isFinite(W.wH2H)) $("wH2H").value = W.wH2H;
          if (Number.isFinite(W.wSR)) $("wSR").value = W.wSR;
          if (Number.isFinite(W.k)) $("kScale").value = W.k;
          const MC = data.mc || {};
          if (Number.isFinite(MC.runs)) $("mcRuns").value = MC.runs;
          if (MC.firstServe) $("firstServe").value = MC.firstServe;
        } catch (err) {
          alert('Archivo JSON inválido');
        }
      };
      reader.readAsText(file);
    }

    function calculate() {
      const { A, B, h2hA, h2hB, weights, format, mcRuns, firstServe } = readAllInputs();
      const errs = validateInputs(A, B);
      if (errs.length) { alert('Corrige los siguientes errores:\n\n' + errs.join('\n')); return; }
      const feats = computeFeatures(A, B, h2hA, h2hB);
      const { pA: pLogit } = combineToProbability(feats, weights, format === 'bo5');
      // Monte Carlo: usar hold% y break% (en proporción)
      const pHoldA = A.hold / 100;
      const pHoldB = B.hold / 100;
      const mcRes = runMonteCarlo(format, pHoldA, pHoldB, firstServe, mcRuns);
      render(A, B, pLogit, feats, weights, mcRes);
      $("confidence").textContent = computeConfidence(A, B) + '%';
    }

    function resetAll() {
      document.querySelectorAll('input').forEach(inp => {
        if (inp.type === 'number') {
          inp.value = inp.id.includes('hold') ? 80 : inp.id.includes('break') ? 25 : inp.max === '10' ? 5 : (inp.id==='mcRuns'?5000:'');
        } else if (inp.type === 'text') {
          inp.value = '';
        }
      });
      $("h2hA").value = 0; $("h2hB").value = 0;
      $("surface").value = 'hard'; $("format").value = 'bo3';
      $("wElo").value = 1.00; $("wSurf").value = 0.80; $("wForm").value = 0.60; $("wH2H").value = 0.40; $("wSR").value = 0.80; $("kScale").value = 1.00;
      $("firstServe").value = 'random';
      $("pA").textContent = '–'; $("pB").textContent = '–';
      $("barA").style.width = '0%'; $("barB").style.width = '0%';
      $("contrib").innerHTML = '';
      $("confidence").textContent = '–';
      $("pA_logit").textContent = '–'; $("pB_logit").textContent = '–';
      $("pA_mc").textContent = '–'; $("pB_mc").textContent = '–';
      $("pA_ci").textContent = ''; $("pB_ci").textContent = '';
      $("oddsA_dec").textContent = '–'; $("oddsB_dec").textContent = '–';
      $("oddsA_amer").textContent = '–'; $("oddsB_amer").textContent = '–';
    }

    // Eventos
    $("calcBtn").addEventListener('click', calculate);
    $("resetBtn").addEventListener('click', resetAll);
    $("exportBtn").addEventListener('click', exportJSON);
    $("importFile").addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) importJSON(e.target.files[0]);
    });
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') { calculate(); }
    });

    // Primer render
    calculate();
  </script>
</body>
</html>
